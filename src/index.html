<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="#">

    <script type="text/javascript" src="../libraries/jquery-2.2.2/http_code.jquery.com_jquery-2.2.2.js"></script>
    <script type="text/javascript" src="../libraries/jquery-ui/http_code.jquery.com_ui_1.11.4_jquery-ui.js"></script>
    <script type="text/javascript" src="../libraries/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript"
            src="../libraries/gsap/http_cdnjs.cloudflare.com_ajax_libs_gsap_1.20.4_TweenMax.min.js"></script>
</head>
<style>

</style>
<body>
<div id="board-wrapper-wrapper">
    <div id="board-wrapper">
        <div id="board"></div>
    </div>
</div>
</body>

<script src="pieces/piece.js"></script>
<script src="pieces/pawn.js"></script>
<script src="pieces/rook.js"></script>
<script src="pieces/bishop.js"></script>
<script src="pieces/knight.js"></script>
<script src="pieces/queen.js"></script>
<script src="pieces/king.js"></script>

<script src="square.js"></script>
<script src="board.js"></script>

<script>
    const itemContainer = $('chess-square');

    let currentHints = [];
    let currentActive;
    let previousMove;

    itemContainer.sortable({
        connectWith: $('chess-square'),
        containment: $('#board-wrapper'),
        items: $('.piece'),
        cursor: "grabbing",
        tolerance: "pointer",
        start: function (e) {
            clearCurrentHints();
            clearCurrentActive();
            getMoves(e.target);
        },
        over: function (e) {
            e.target.classList.add("hover");
        },
        out: function (e) {
            e.target.classList.remove("hover");
        },
        receive: function (e, ui) {
            if (!e.target.querySelectorAll(".hint, .capture-hint").length) {
                ui.sender.sortable("cancel");
                return;
            }

            if (ui.item[0] instanceof Pawn && (e.target.y === 7 || e.target.y === 0)) {
                clearCurrentHints();
                e.target.addPromotionMenu(ui.item[0].white).then(function (value) {
                    if (value === undefined) {
                        ui.sender.sortable("cancel");
                    } else {
                        value.classList.remove("promotion-option");
                        makeMove(ui.sender[0], e.target, value);
                        resetOnClick();
                    }
                });

            } else {
                makeMove(ui.sender[0], e.target, ui.item[0]);
            }
        }
    });

    function resetOnClick() {
        $('.piece').on("click", function (e) {
            clearCurrentHints();
            clearCurrentActive();
            getMoves(e.target.parentNode);
        });

        itemContainer.sortable("option", "items", $('.piece'));
    }

    resetOnClick();

    function makeMove(prevPos, newPos, piece) {
        prevPos.removePiece();
        let capture = newPos.removePiece();
        newPos.addPiece(piece);
        playSound(capture);

        removeEnPassant();
        checkEnPassant(prevPos, newPos, piece);

        swapPreviousMove(prevPos, newPos);

        clearCurrentHints();
        clearCurrentActive();
        printBoard();
    }

    function getMoves(square) {
        let piece = square.piece;
        let moves = piece.getMoves(square.y, square.x);
        let rect = piece.getBoundingClientRect();

        square.classList.add("currentMove");
        currentActive = square;

        for (let move of moves) {
            if (move.capture) {
                move.square.addCaptureHint();
            } else {
                move.square.addHint();
            }

            $(move.square).on("click", function () {
                const newPos = this;
                const prevPos = square;

                if (piece instanceof Pawn && (newPos.y === 7 || newPos.y === 0)) {
                    clearCurrentHints();
                    piece.remove();

                    this.addPromotionMenu(piece.white).then(function (value) {
                        if (value === undefined) {
                            prevPos.appendChild(piece);
                        } else {
                            value.classList.remove("promotion-option");
                            makeMove(prevPos, newPos, value);
                            resetOnClick();
                        }
                    });
                } else {
                    makeMove(prevPos, newPos, piece);

                    TweenMax.set(piece, {x: 0, y: 0});

                    let newRect = piece.getBoundingClientRect();

                    TweenMax.from(piece, 0.2, {
                        x: rect.left - newRect.left,
                        y: rect.top - newRect.top,
                        ease: Power3.linear,
                        onComplete: () => piece.style.zIndex = "1"
                    });
                }
            });
        }

        currentHints = moves;
    }

    function clearCurrentHints() {
        for (let hint of currentHints) {
            hint.square.removeHint();
            $(hint.square).unbind("click");
        }
        currentHints = [];
    }

    function clearCurrentActive() {
        if (currentActive !== undefined) {
            currentActive.classList.remove("currentMove");
            currentActive = undefined;
        }
    }

    let currentEnPassant;

    function checkEnPassant(prevPos, newPos, piece) {
        if (!(piece instanceof Pawn)) return;
        if (Math.abs(prevPos.y - newPos.y) !== 2) return;

        if (prevPos.y === 1) {
            currentEnPassant = board[prevPos.y + 1][prevPos.x]
        } else {
            currentEnPassant = board[prevPos.y - 1][prevPos.x]
        }

        currentEnPassant.addEnPassant(piece.white);
    }

    function removeEnPassant() {
        if (!(currentEnPassant instanceof Square)) return;

        if (currentEnPassant.piece === null) return;

        if (currentEnPassant.piece.getPieceLetter === "e") currentEnPassant.piece = null;
    }

    function playSound(capture) {
        if (capture) {
            new Audio("../assets/sound/capture.webm").play();
        } else {
            new Audio("../assets/sound/move-self.webm").play();
        }
    }

    function swapPreviousMove(prevPos, newPos) {
        if (previousMove !== undefined) {
            previousMove.prevPos.classList.remove("previousMove");
            previousMove.newPos.classList.remove("previousMove");
        }

        prevPos.classList.add("previousMove");
        newPos.classList.add("previousMove");
        previousMove = {
            prevPos: prevPos,
            newPos: newPos,
        }
    }

    printBoard();
</script>
</html>
